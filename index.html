<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚¢ã‚¤ã‚³ãƒ³ç·¨é›†ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 {
      margin: 10px;
    }
    canvas {
      border: 1px solid #ccc;
      width: 100%;
      max-width: 360px;
      background: #fff;
      touch-action: none;
      user-select: none;
    }
    .controls {
      padding: 10px;
      max-width: 360px;
      margin: auto;
    }
    .layer-group {
      margin: 10px 0;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      text-align: left;
    }
    input[type="range"] {
      width: 100%;
    }
    label {
      display: block;
      font-size: 0.9em;
      margin-top: 5px;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1em;
      background: #3c3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    @media (min-width: 600px) {
      canvas {
        max-width: 512px;
      }
      .controls {
        max-width: 512px;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ˜ ã‚¢ã‚¤ã‚³ãƒ³åˆæˆãƒ„ãƒ¼ãƒ«</h1>
  <input type="file" id="upload" accept="image/*" />
  <canvas id="canvas" width="512" height="512"></canvas>

  <div class="controls">
    <div class="layer-group">
      <h3>ğŸ‘“ ã‚µãƒ³ã‚°ãƒ©ã‚¹</h3>
      <label><input type="checkbox" id="acc-sunglass" checked> è¡¨ç¤ºã™ã‚‹</label>
      <label>æ¨ªã‚µã‚¤ã‚º: <input type="range" id="sunglass-w" min="10" max="300" value="100"></label>
      <label>ç¸¦ã‚µã‚¤ã‚º: <input type="range" id="sunglass-h" min="10" max="200" value="40"></label>
      <label>ä½ç½®X: <input type="range" id="sunglass-x" min="0" max="412" value="180"></label>
      <label>ä½ç½®Y: <input type="range" id="sunglass-y" min="0" max="472" value="200"></label>
      <label>å›è»¢è§’åº¦ï¼ˆÂ°ï¼‰: <input type="range" id="sunglass-rotation" min="-180" max="180" value="0"></label>
      <label>é€æ˜åº¦: <input type="range" id="sunglass-opacity" min="0" max="1" step="0.01" value="1"></label>
    </div>

    <div class="layer-group">
      <h3>ğŸ§¢ ã‚¢ãƒ«ãƒŸãƒ›ã‚¤ãƒ«å¸½å­</h3>
      <label><input type="checkbox" id="acc-hat" checked> è¡¨ç¤ºã™ã‚‹</label>
      <label>ä½ç½®X: <input type="range" id="hat-x" min="0" max="512" value="180"></label>
      <label>ä½ç½®Y: <input type="range" id="hat-y" min="0" max="512" value="100"></label>
      <label>æ¨ªã‚µã‚¤ã‚º: <input type="range" id="hat-w" min="10" max="512" value="120"></label>
      <label>ç¸¦ã‚µã‚¤ã‚º: <input type="range" id="hat-h" min="10" max="512" value="80"></label>
      <label>å›è»¢è§’åº¦ï¼ˆÂ°ï¼‰: <input type="range" id="hat-rotation" min="-180" max="180" value="0"></label>
      <label>é€æ˜åº¦: <input type="range" id="hat-opacity" min="0" max="1" step="0.01" value="1"></label>
    </div>

    <label><input type="checkbox" id="show-lines" checked> âœ¨é›†ä¸­ç·šã‚’è¡¨ç¤º</label><br>
    <button id="download">ğŸ“¥ PNGä¿å­˜</button>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    // ç”»åƒèª­ã¿è¾¼ã¿
    const sunglassImg = new Image();
    sunglassImg.src = "pixel-sunglasses-19.png";

    const linesImg = new Image();
    linesImg.src = "concentration-lines.png";

    const accessories = {
      hat: {
        img: new Image(),
        src: "Aluminum_foil_hat.png",
        x: 180, y: 100, w: 120, h: 80,
        opacity: 1, visible: true, rotation: 0
      }
    };
    accessories.hat.img.src = accessories.hat.src;
    accessories.hat.img.onload = () => draw();

    // çŠ¶æ…‹ä¿æŒ
    let userImg = null;
    let imgOffset = { x: 0, y: 0 };
    let dragging = false;
    let dragStart = { x: 0, y: 0 };
    let dragTarget = null; // "image" or "sunglass" or null

    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    const params = {
      sw: 100,
      sh: 40,
      sx: 180,
      sy: 200,
      rotation: 0,
      opacity: 1,
      visible: true,
      showLines: true
    };

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    document.getElementById("upload").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        userImg = new Image();
        userImg.onload = () => {
          imgOffset = { x: 0, y: 0 };
          draw();
        };
        userImg.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    // å›è»¢æç”»é–¢æ•°
    function drawRotatedImage(img, x, y, w, h, rotation, opacity = 1) {
      ctx.save();
      ctx.globalAlpha = opacity;
      ctx.translate(x + w / 2, y + h / 2);
      ctx.rotate((rotation * Math.PI) / 180);
      ctx.drawImage(img, -w / 2, -h / 2, w, h);
      ctx.restore();
      ctx.globalAlpha = 1;
    }

    // æç”»å‡¦ç†
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»åƒã‚’ä¸­å¤®ãƒˆãƒªãƒŸãƒ³ã‚°ã—ã¦è¡¨ç¤º
      if (userImg) {
        const minSize = Math.min(userImg.width, userImg.height);
        const sx = (userImg.width - minSize) / 2 - imgOffset.x;
        const sy = (userImg.height - minSize) / 2 - imgOffset.y;
        ctx.drawImage(userImg, sx, sy, minSize, minSize, 0, 0, 512, 512);
      }

      // é›†ä¸­ç·šè¡¨ç¤º
      if (params.showLines && linesImg.complete) {
        ctx.drawImage(linesImg, 0, 0, 512, 512);
      }

      // ã‚µãƒ³ã‚°ãƒ©ã‚¹è¡¨ç¤º
      if (params.visible && sunglassImg.complete) {
        drawRotatedImage(sunglassImg, params.sx, params.sy, params.sw, params.sh, params.rotation, params.opacity);
      }

      // å¸½å­è¡¨ç¤º
      const hat = accessories.hat;
      if (hat.visible && hat.img.complete) {
        drawRotatedImage(hat.img, hat.x, hat.y, hat.w, hat.h, hat.rotation, hat.opacity);
      }
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š (ã‚µãƒ³ã‚°ãƒ©ã‚¹)
    ["w", "h", "x", "y", "opacity", "rotation"].forEach(key => {
      document.getElementById(`sunglass-${key}`).addEventListener("input", e => {
        if (key === "w") params.sw = parseFloat(e.target.value);
        else if (key === "h") params.sh = parseFloat(e.target.value);
        else if (key === "x") params.sx = parseFloat(e.target.value);
        else if (key === "y") params.sy = parseFloat(e.target.value);
        else if (key === "opacity") params.opacity = parseFloat(e.target.value);
        else if (key === "rotation") params.rotation = parseFloat(e.target.value);
        draw();
      });
    });

    // ã‚µãƒ³ã‚°ãƒ©ã‚¹è¡¨ç¤ºåˆ‡æ›¿ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
    document.getElementById("acc-sunglass").addEventListener("change", e => {
      params.visible = e.target.checked;
      draw();
    });

    // å¸½å­ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    ["x", "y", "w", "h", "opacity", "rotation"].forEach(key => {
      document.getElementById(`hat-${key}`).addEventListener("input", e => {
        accessories.hat[key] = parseFloat(e.target.value);
        draw();
      });
    });

    // å¸½å­è¡¨ç¤ºåˆ‡æ›¿ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
    document.getElementById("acc-hat").addEventListener("change", e => {
      accessories.hat.visible = e.target.checked;
      draw();
    });

    // é›†ä¸­ç·šè¡¨ç¤ºåˆ‡æ›¿
    document.getElementById("show-lines").addEventListener("change", e => {
      params.showLines = e.target.checked;
      draw();
    });

    // PNGä¿å­˜ãƒœã‚¿ãƒ³
    document.getElementById("download").addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "icon.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    // canvasä¸Šã®åº§æ¨™å–å¾—
    const getPos = e => {
      const rect = canvas.getBoundingClientRect();
      if (e.touches) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      } else {
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
      }
    };

    // å›è»¢çŸ©å½¢åˆ¤å®šï¼ˆåº§æ¨™ãŒå›è»¢ã—ãŸçŸ©å½¢å†…ã‹ã©ã†ã‹ï¼‰
    function isPointInRotatedRect(px, py, rx, ry, rw, rh, rotation) {
      const cx = rx + rw / 2;
      const cy = ry + rh / 2;
      const rad = (-rotation * Math.PI) / 180;
      const dx = px - cx;
      const dy = py - cy;
      const x = dx * Math.cos(rad) - dy * Math.sin(rad) + rw / 2;
      const y = dx * Math.sin(rad) + dy * Math.cos(rad) + rh / 2;
      return 0 <= x && x <= rw && 0 <= y && y <= rh;
    }

    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹åˆ¤å®š
    function startDrag(e) {
      const pos = getPos(e);
      if (params.visible && isPointInRotatedRect(pos.x, pos.y, params.sx, params.sy, params.sw, params.sh, params.rotation)) {
        dragTarget = "sunglass";
      } else if (userImg) {
        dragTarget = "image";
      } else {
        dragTarget = null;
      }
      dragging = dragTarget !== null;
      dragStart = pos;
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­å‡¦ç†
    function onDrag(e) {
      if (!dragging) return;
      const pos = getPos(e);
      const dx = pos.x - dragStart.x;
      const dy = pos.y - dragStart.y;

      if (dragTarget === "image" && userImg) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»åƒã®ç§»å‹•ã¯æ‹¡å¤§ç¸®å°å¾Œã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è€ƒæ…®
        imgOffset.x -= dx * (userImg.width / canvas.width);
        imgOffset.y -= dy * (userImg.height / canvas.height);
      } else if (dragTarget === "sunglass") {
        params.sx += dx;
        params.sy += dy;
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—å›é¿ã§æ›´æ–°ã—ãªã„ãŒã€åŒæœŸã—ãŸã„ãªã‚‰åˆ¥é€”å‡¦ç†ãŒå¿…è¦
        // ã“ã“ã§ã¯æç”»ã®ã¿
      }
      dragStart = pos;
      draw();
   
